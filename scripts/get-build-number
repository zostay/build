#!/usr/bin/env bash
set -euo pipefail

# Script to get build number from S3-compatible object store
#
# This script retrieves build number information from the qubling-cloud-config bucket.
# Supports any S3-compatible object store (AWS S3, DO Spaces, MinIO, etc.)
#
# Required environment variables:
# - AWS_ACCESS_KEY_ID: Your object store access key
# - AWS_SECRET_ACCESS_KEY: Your object store secret key
# - AWS_ENDPOINT_URL: Endpoint for S3-compatible services (e.g., https://nyc3.digitaloceanspaces.com)
#
# Returns "0" if the build number doesn't exist.

usage() {
    echo "Usage: $0 <app-name> [--image-name <name>] [--env-name <env>]"
    echo "  app-name     - Required: Name of the application"
    echo "  --image-name - Optional: Name of the image (default: main)"
    echo "  --env-name   - Optional: Environment name (default: prod)"
    echo ""
    echo "Example:"
    echo "  $0 myapp"
    echo "  $0 myapp --image-name worker --env-name staging"
    exit 1
}

APP_NAME=""
IMAGE_NAME="main"
ENV_NAME="prod"
BUCKET_NAME="${BUILD_NUMBER_BUCKET:-qubling-cloud-production}"

while [[ $# -gt 0 ]]; do
    case $1 in
        --image-name)
            IMAGE_NAME="$2"
            shift 2
            ;;
        --env-name)
            ENV_NAME="$2"
            shift 2
            ;;
        -h|--help)
            usage
            ;;
        -*)
            echo "Unknown option $1"
            usage
            ;;
        *)
            if [[ -z "$APP_NAME" ]]; then
                APP_NAME="$1"
                shift
            else
                echo "Unexpected argument: $1"
                usage
            fi
            ;;
    esac
done

if [[ -z "$APP_NAME" ]]; then
    echo "Error: app-name is required"
    usage
fi

OBJECT_KEY="build-number/${APP_NAME}/${IMAGE_NAME}/${ENV_NAME}.txt"

# Validate required environment variables
if [[ -z "${AWS_ACCESS_KEY_ID:-}" ]]; then
    echo "Error: AWS_ACCESS_KEY_ID environment variable is required" >&2
    exit 1
fi

if [[ -z "${AWS_SECRET_ACCESS_KEY:-}" ]]; then
    echo "Error: AWS_SECRET_ACCESS_KEY environment variable is required" >&2
    exit 1
fi

if [[ -z "${AWS_ENDPOINT_URL:-}" ]]; then
    echo "Error: AWS_ENDPOINT_URL environment variable is required for S3-compatible services" >&2
    exit 1
fi

# Clean up environment variables
AWS_ACCESS_KEY_ID=$(echo -n "$AWS_ACCESS_KEY_ID" | tr -d '\r\n')
AWS_SECRET_ACCESS_KEY=$(echo -n "$AWS_SECRET_ACCESS_KEY" | tr -d '\r\n')
AWS_ENDPOINT_URL=$(echo -n "$AWS_ENDPOINT_URL" | tr -d '\r\n')

# S3 V2 signature implementation
HOST_FOR_HEADER=$(echo "$AWS_ENDPOINT_URL" | cut -d'/' -f3)
DATE=$(LC_ALL=C date -u +"%a, %d %b %Y %H:%M:%S +0000")
STRING_TO_SIGN="GET\n\n\n${DATE}\n/${BUCKET_NAME}/${OBJECT_KEY}"
SIGNATURE=$(echo -en "${STRING_TO_SIGN}" | openssl sha1 -hmac "$AWS_SECRET_ACCESS_KEY" -binary | base64)

# Make the GET request
HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/get_build_number.txt \
  -H "Host: ${HOST_FOR_HEADER}" \
  -H "Date: ${DATE}" \
  -H "Authorization: AWS ${AWS_ACCESS_KEY_ID}:${SIGNATURE}" \
  "${AWS_ENDPOINT_URL}/${BUCKET_NAME}/${OBJECT_KEY}" 2>/dev/null)

# If object doesn't exist (404), return 0
if [[ "$HTTP_CODE" == "404" ]]; then
    rm -f /tmp/get_build_number.txt
    echo "0"
    exit 0
fi

# If successful, return the build number
if [[ "$HTTP_CODE" == "200" ]]; then
    BUILD_NUMBER=$(cat /tmp/get_build_number.txt)
    rm -f /tmp/get_build_number.txt
    echo "$BUILD_NUMBER"
    exit 0
fi

# Otherwise, error
echo "Error: Failed to retrieve build number. HTTP status code: $HTTP_CODE" >&2
if [[ -f /tmp/get_build_number.txt ]]; then
    cat /tmp/get_build_number.txt >&2
    rm -f /tmp/get_build_number.txt
fi
exit 1
