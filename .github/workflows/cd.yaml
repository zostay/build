name: Continuous Deployment

on:
  workflow_call:
    inputs:
      genifest-version:
        description: 'Version of genifest to install (e.g., "latest" or "1.0.0-rc6")'
        required: false
        type: string
        default: 'latest'
      genifest-group:
        description: 'Genifest group to run (e.g., "all", "config-only", "prod")'
        required: false
        type: string
        default: 'all'
      genifest-tag:
        description: 'Additional tag expression to apply (e.g., "!secret-*")'
        required: false
        type: string
        default: ''
      working-directory:
        description: 'Working directory containing genifest.yaml configuration'
        required: false
        type: string
        default: '.'
      output-mode:
        description: 'Output mode for genifest (auto, color, plain, markdown)'
        required: false
        type: string
        default: 'plain'
      commit-changes:
        description: 'Whether to commit the manifest changes'
        required: false
        type: boolean
        default: true
      commit-message:
        description: 'Commit message for manifest changes'
        required: false
        type: string
        default: 'chore: update kubernetes manifests via genifest'
      push-changes:
        description: 'Whether to push committed changes (requires commit-changes: true)'
        required: false
        type: boolean
        default: true
      git-user-name:
        description: 'Git user name for commits'
        required: false
        type: string
        default: 'github-actions[bot]'
      git-user-email:
        description: 'Git user email for commits'
        required: false
        type: string
        default: 'github-actions[bot]@users.noreply.github.com'
    outputs:
      changes-made:
        description: 'Whether any manifest changes were made'
        value: ${{ jobs.deploy.outputs.changes-made }}
      commit-sha:
        description: 'SHA of the commit with manifest changes (if committed)'
        value: ${{ jobs.deploy.outputs.commit-sha }}

jobs:
  deploy:
    name: Update Manifests
    runs-on: ubuntu-latest
    outputs:
      changes-made: ${{ steps.check-changes.outputs.changes-made }}
      commit-sha: ${{ steps.commit.outputs.commit-sha }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Install genifest
        env:
          GH_TOKEN: ${{ github.token }}
          INPUT_VERSION: ${{ inputs.genifest-version }}
        run: |
          set -euo pipefail
          echo "Installing genifest..."
          
          # Determine version to install
          if [ "$INPUT_VERSION" = "latest" ]; then
            VERSION=$(gh api repos/zostay/genifest/releases/latest --jq '.tag_name' | sed 's/^v//')
            if [ -z "$VERSION" ]; then
              echo "Error: Failed to fetch latest version"
              exit 1
            fi
            # Validate the fetched version follows semantic versioning
            if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$'; then
              echo "Error: Fetched version does not match expected format: $VERSION"
              exit 1
            fi
          else
            # Validate version format (semantic versioning with optional prerelease)
            if ! echo "$INPUT_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$'; then
              echo "Error: Invalid version format: $INPUT_VERSION"
              echo "Expected format: X.Y.Z or X.Y.Z-prerelease (e.g., 1.0.0 or 1.0.0-rc6)"
              exit 1
            fi
            VERSION="$INPUT_VERSION"
          fi
          
          echo "Installing genifest version: $VERSION"
          
          # Detect platform
          OS_NAME=$(uname -s | tr '[:upper:]' '[:lower:]')
          OS_ARCH=$(uname -m)
          
          # Map architecture names
          if [ "$OS_ARCH" = "x86_64" ]; then
            OS_ARCH="amd64"
          fi
          
          echo "Platform: $OS_NAME-$OS_ARCH"
          
          # Create local bin directory and add to PATH
          mkdir -p "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          
          # Download binary using GitHub CLI with built-in verification
          ASSET_NAME="genifest-$VERSION-$OS_NAME-$OS_ARCH"
          echo "Downloading asset: $ASSET_NAME"
          
          gh release download "v$VERSION" \
            --repo zostay/genifest \
            --pattern "$ASSET_NAME" \
            --output "$HOME/.local/bin/genifest"
          
          chmod +x "$HOME/.local/bin/genifest"
          
          # Verify installation
          "$HOME/.local/bin/genifest" version

      - name: Validate Configuration
        working-directory: ${{ inputs.working-directory }}
        env:
          OUTPUT_MODE: ${{ inputs.output-mode }}
        run: |
          set -euo pipefail
          echo "Validating genifest configuration..."
          genifest validate --output="$OUTPUT_MODE"

      - name: Run genifest
        working-directory: ${{ inputs.working-directory }}
        env:
          GENIFEST_GROUP: ${{ inputs.genifest-group }}
          GENIFEST_TAG: ${{ inputs.genifest-tag }}
          OUTPUT_MODE: ${{ inputs.output-mode }}
        run: |
          set -euo pipefail
          echo "Running genifest..."
          
          # Build command arguments safely using arrays
          ARGS=("run" "--output=$OUTPUT_MODE")
          
          # Add tag if specified (placed before group as per genifest CLI)
          if [ -n "$GENIFEST_TAG" ]; then
            ARGS+=("--tag" "$GENIFEST_TAG")
          fi
          
          # Add group argument
          ARGS+=("$GENIFEST_GROUP")
          
          echo "Running: genifest ${ARGS[*]}"
          genifest "${ARGS[@]}"

      - name: Check for Changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "No manifest changes detected"
            echo "changes-made=false" >> $GITHUB_OUTPUT
          else
            echo "Manifest changes detected:"
            git diff --stat
            echo "changes-made=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit Changes
        id: commit
        if: inputs.commit-changes && steps.check-changes.outputs.changes-made == 'true'
        env:
          GIT_USER_NAME: ${{ inputs.git-user-name }}
          GIT_USER_EMAIL: ${{ inputs.git-user-email }}
          COMMIT_MESSAGE: ${{ inputs.commit-message }}
        run: |
          git config user.name "$GIT_USER_NAME"
          git config user.email "$GIT_USER_EMAIL"
          
          git add -A
          git commit -m "$COMMIT_MESSAGE"
          
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit-sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Committed changes with SHA: $COMMIT_SHA"

      - name: Push Changes
        if: inputs.commit-changes && inputs.push-changes && steps.check-changes.outputs.changes-made == 'true'
        run: |
          git push
